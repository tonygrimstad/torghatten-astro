# Torghatten Maraton - Apache config for Domeneshop
# Deployment til /www/astro/ (DocumentRoot konfigurert i Domeneshop kontrollpanel)

# Aktiver URL rewriting
RewriteEngine On

# VIKTIG: Steng directory listing (sikkerhet)
Options -Indexes

# DirectoryIndex - hvilke filer Apache skal lete etter
DirectoryIndex index.html index.htm

# ========================================
# MAINTENANCE MODE
# ========================================
# Hvis filen .maintenance finnes, vis maintenance.html
# For å aktivere: Last opp en tom .maintenance fil via FTP
# For å deaktivere: Slett .maintenance filen
RewriteCond %{DOCUMENT_ROOT}/.maintenance -f
RewriteCond %{REQUEST_URI} !^/maintenance\.html$
RewriteCond %{REQUEST_URI} !\.(css|js|png|jpg|jpeg|gif|ico|svg)$
RewriteRule ^(.*)$ /maintenance.html [R=503,L]
Header always set Retry-After "60" env=REDIRECT_STATUS

# ========================================
# SPRÅK OG ROUTING
# ========================================

# Språk-baserad redirect från root til /no/
RewriteCond %{REQUEST_URI} ^/?$
RewriteRule ^/?$ /no/ [R=301,L]

# Håndter Astro's statiske routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^([^/]+)/([^/]+)/?$ /$1/$2/index.html [L]

# Eksisterende filer och directories
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([^/]+)/?$ /$1/index.html [L]

# Custom error documents
# 404.html genereras av Astro från src/pages/404.astro
# 500.html ligger i /www/500.html (utanför /www/astro/) för å alltid vara tilgjengelig
ErrorDocument 403 /404.html
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html
ErrorDocument 503 /500.html

# Gzip compression for better performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Cache static assets
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
</IfModule>
