---
import Layout from "../layouts/Layout.astro";
import LightboxGallery from "../components/LightboxGallery.astro";
import { galleriData } from "../data/galleriIndex";
import { useTranslations } from "../utils/useTranslations.ts";

const { t, currentLang } = useTranslations(Astro.url);
const sortedYears = [...galleriData].sort((a, b) => b.year - a.year);

// Use translated SEO titles
const title = t("seo.galleryTitle");
const description = t("seo.galleryDescription");
---

<Layout title={title} description={description} lang={currentLang}>
  <!-- Modern Hero Section for Gallery with Random Background -->
  <section
    id="gallery-hero"
    class="relative min-h-[60vh] md:min-h-[70vh] flex items-center justify-center text-white mt-20 md:mt-24"
  >
    <!-- Gradient Overlay -->
    <div
      class="absolute inset-0 bg-linear-to-br from-purple-900/80 via-indigo-800/70 to-blue-700/80"
    >
    </div>

    <!-- Content -->
    <div class="relative z-10 max-w-4xl mx-auto text-center px-6 py-16">
      <h1 class="text-5xl md:text-7xl font-bold mb-6 drop-shadow-lg">
        {t("gallery.modernTitle", "Øyeblikk fra Løpet")}
      </h1>
      <p
        class="text-xl md:text-2xl opacity-95 mb-8 max-w-3xl mx-auto drop-shadow-md"
      >
        {
          t(
            "gallery.subtitle",
            "Se tilbake på magiske øyeblikk fra Torghatten Maraton gjennom årene",
          )
        }
      </p>
      <div class="w-32 h-1 bg-yellow-400 mx-auto shadow-lg"></div>
    </div>

    <!-- Scroll indicator -->
    <div
      class="absolute bottom-8 left-1/2 transform -translate-x-1/2 animate-bounce"
    >
      <svg
        class="w-6 h-6 text-white/80"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
      </svg>
    </div>
  </section>

  <script>
    // Random background image selection for gallery hero
    document.addEventListener("DOMContentLoaded", () => {
      const heroSection = document.getElementById("gallery-hero");
      if (heroSection) {
        const heroImages = [
          "/images/banner/cropped-torghatten20150217-1.jpg",
          "/images/banner/cropped-i-SmkP5Tb.jpg",
          "/images/banner/cropped-20150502torgattenmaraton-34.jpg",
          "/images/banner/cropped-20150502torgattenmaraton-21.jpg",
          "/images/banner/cropped-i-j4tV97J.jpg",
          "/images/banner/30mai-TorghattenMaraton-9721.jpg",
          "/images/banner/30mai-TorghattenMaraton-9712.jpg",
          "/images/banner/30mai-TorghattenMaraton-9095.jpg",
        ];

        const randomImage =
          heroImages[Math.floor(Math.random() * heroImages.length)];
        heroSection.style.backgroundImage = `url('${randomImage}')`;
        heroSection.style.backgroundSize = "cover";
        heroSection.style.backgroundPosition = "center";
        heroSection.style.backgroundAttachment = "fixed";
      }
    });
  </script>

  <!-- Sticky Navigation Section -->
  <section
    class="bg-white/95 backdrop-blur-sm py-6 border-b border-gray-200 sticky top-20 md:top-24 z-40 shadow-lg"
  >
    <div class="max-w-6xl mx-auto px-6">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <span
            class="text-gray-700 font-semibold text-sm sm:text-base flex items-center gap-2"
          >
            <svg
              class="w-5 h-5 text-purple-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
            {t("gallery.selectYear", "Velg år:")}
          </span>
          <select
            id="yearFilter"
            class="bg-white border border-gray-300 text-gray-800 px-4 py-2 rounded-xl shadow-sm hover:border-purple-500 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-sm font-medium"
          >
            <option value="all">{t("visAlleAar")}</option>
            {
              sortedYears.map((g) => (
                <option value={`year-${g.year}`}>{g.year}</option>
              ))
            }
          </select>
        </div>
        <div
          class="flex items-center gap-2 text-xs sm:text-sm text-gray-500 bg-gray-100 px-3 py-2 rounded-lg"
        >
          <svg
            class="w-4 h-4 text-purple-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          <span id="photoCounter" class="font-medium">
            {sortedYears.reduce((acc, year) => acc + year.photos.length, 0)}
            {t("gallery.photoCount", "bilder totalt")}
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- Gallery Content -->
  <section class="py-12 bg-gray-50">
    <div class="max-w-6xl mx-auto px-6">
      {
        sortedYears.map((entry) => (
          <div
            class="gallery-year mb-16"
            data-year={`year-${entry.year}`}
            data-photo-count={entry.photos.length}
          >
            <LightboxGallery
              year={entry.year}
              photos={entry.photos}
              photographers={entry.photographers || []}
            />
          </div>
        ))
      }
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const select = document.getElementById("yearFilter") as HTMLSelectElement;
      const sections = document.querySelectorAll(
        ".gallery-year",
      ) as NodeListOf<HTMLElement>;
      const counter = document.getElementById("photoCounter");
      const counterText =
        counter?.textContent?.split(" ").slice(-2).join(" ") || "bilder totalt";

      function updateCounter(selectedValue: string) {
        if (!counter) return;

        if (selectedValue === "all") {
          // Kalkuler totalt for alle år
          const totalPhotos = Array.from(sections).reduce((sum, section) => {
            const count = parseInt(section.dataset.photoCount || "0");
            return sum + count;
          }, 0);
          counter.textContent = `${totalPhotos} ${counterText}`;
        } else {
          // Finn det valgte året og vis antallet for det året
          const selectedSection = Array.from(sections).find(
            (section) => section.dataset.year === selectedValue,
          );
          if (selectedSection) {
            const count = selectedSection.dataset.photoCount || "0";
            counter.textContent = `${count} ${counterText}`;
          }
        }
      }

      select?.addEventListener("change", () => {
        const val = select.value;
        sections.forEach((sectionEl) => {
          const match = sectionEl.dataset.year === val;
          sectionEl.style.display = val === "all" || match ? "" : "none";
        });

        // Oppdater photo counter
        updateCounter(val);

        // Scroll til valgt år
        if (val !== "all") {
          const targetSection = document.querySelector(
            `[data-year="${val}"]`,
          ) as HTMLElement;
          if (targetSection) {
            // Finn heading eller første element med årstall/fotograf
            const yearHeading = targetSection.querySelector(
              "h2, h3, .year-header",
            ) as HTMLElement;
            const scrollTarget = yearHeading || targetSection;

            // Scroll til årstall/fotograf-seksjonen med riktig margin
            const stickyNavHeight = 180; // Justert for den nye sticky nav posisjonen
            const elementPosition = scrollTarget.offsetTop - stickyNavHeight;
            window.scrollTo({
              top: elementPosition,
              behavior: "smooth",
            });
          }
        } else {
          // Scroll til toppen av gallery-innholdet når "vis alle år" velges
          const gallerySection = document.querySelector(
            ".py-12.bg-gray-50",
          ) as HTMLElement;
          if (gallerySection) {
            const stickyNavHeight = 100; // Justert for ny sticky nav posisjon
            const elementPosition = gallerySection.offsetTop - stickyNavHeight;
            window.scrollTo({
              top: elementPosition,
              behavior: "smooth",
            });
          }
        }
      });
    });
  </script>
</Layout>
