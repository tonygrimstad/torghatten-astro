---
import { useTranslations } from "../utils/useTranslations.ts";
import { navLinks } from "../config/navLinks.ts";
import { isFeatureActive, isValidToggleKey } from "../config/siteConfig.ts";

const { t, currentLang } = useTranslations(Astro.url);

const path = Astro.url.pathname;
const restPath = path.split("/").slice(2).join("/");
const otherLang = currentLang === "no" ? "en" : "no";
const switchUrl = `/${otherLang}/${restPath}`;
---

<header
  class="fixed top-0 left-0 w-full bg-linear-to-b from-black/70 to-black/40 backdrop-blur-sm text-yellow-400 z-50 shadow-lg border-b border-white/10"
>
  <div class="max-w-6xl mx-auto px-6 py-2 flex justify-between items-center">
    <!-- Logo og navn -->
    <a
      href={`/${currentLang}/`}
      class="flex items-center gap-3 hover:opacity-90 transition-opacity group"
      style="perspective: 200px;"
    >
      <div class="relative logo-container">
        <div
          class="w-20 h-20 md:w-24 md:h-24 rounded-full bg-transparent overflow-hidden transition-all duration-500 transform-gpu logo-3d group-hover:scale-110"
          style="
            transform-style: preserve-3d;
            box-shadow:
              0 0 20px rgba(255, 193, 7, 0.3),
              0 15px 35px rgba(0, 0, 0, 0.3),
              inset 0 2px 8px rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 193, 7, 0.6);
          "
        >
          <img
            src="/images/logos/torghatten-maraton2.jpg"
            alt="Torghatten Maraton logo"
            class="w-full h-full object-cover rounded-full transition-all duration-500 filter grayscale group-hover:grayscale-0 group-hover:brightness-110"
            style="transform: translateZ(4px);"
          />
          <!-- 3D lys-effekt -->
          <div
            class="absolute inset-0 rounded-full transition-all duration-500 pointer-events-none"
            style="
              background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.4) 0%,
                transparent 30%,
                transparent 70%,
                rgba(0, 0, 0, 0.2) 100%);
              transform: translateZ(8px);
            "
          >
          </div>
          <!-- Hover fargeoverlay -->
          <div
            class="absolute inset-0 bg-linear-to-br from-yellow-400/0 to-blue-600/0 transition-all duration-500 group-hover:from-yellow-400/25 group-hover:to-blue-600/15 rounded-full"
            style="transform: translateZ(6px);"
          >
          </div>
        </div>
        <!-- 3D skygge -->
        <div
          class="absolute top-0 left-0 w-20 h-20 md:w-24 md:h-24 rounded-full transition-all duration-500 -z-10"
          style="
            background: radial-gradient(ellipse at center,
              rgba(255, 193, 7, 0.2) 0%,
              rgba(255, 193, 7, 0.1) 30%,
              transparent 70%);
            transform: rotateX(90deg) translateZ(-8px) scale(1.1);
            filter: blur(3px);
          "
        >
        </div>
      </div>
      <span
        class="text-xl font-bold tracking-tight text-yellow-400 group-hover:text-yellow-300 transition-colors"
      >
        Torghatten Maraton
      </span>
    </a>

    <!-- Desktop navigasjon -->
    <nav class="hidden md:flex space-x-6">
      {
        navLinks
          .filter(
            (link) =>
              !link.toggle ||
              (isValidToggleKey(link.toggle) && isFeatureActive(link.toggle)),
          )
          .map((link) =>
            "dropdown" in link ? (
              <div class="relative group">
                <button
                  class="hover:underline whitespace-nowrap"
                  type="button"
                  aria-haspopup="true"
                  aria-expanded="false"
                  aria-label={`칀pne ${t(`nav.${link.label}`)} meny`}
                >
                  {t(`nav.${link.label}`)}
                </button>
                <div class="absolute left-0 min-w-50 bg-black/90 rounded shadow-md z-50 hidden group-hover:flex flex-col">
                  {link.dropdown.map((item) => (
                    <a
                      href={`/${currentLang}/${item.href}`}
                      target={item.external ? "_blank" : undefined}
                      rel={item.external ? "noopener noreferrer" : undefined}
                      class="block px-4 py-2 hover:bg-yellow-500 hover:text-black whitespace-nowrap"
                    >
                      {t(`nav.${item.label}`)}
                    </a>
                  ))}
                </div>
              </div>
            ) : (
              <a
                href={`/${currentLang}/${link.href}`}
                class="hover:underline whitespace-nowrap"
              >
                {t(`nav.${link.label}`)}
              </a>
            ),
          )
      }
    </nav>

    <!-- Spr친kvalg desktop -->
    <div class="hidden md:flex space-x-4 items-center">
      <a href={switchUrl} class="hover:text-yellow-300">
        {currentLang === "no" ? "游섫릖 English" : "游游 Norsk"}
      </a>
    </div>

    <!-- Mobilknapp - WCAG 2.1 AA kompatibel -->
    <button
      id="mobile-menu-toggle"
      class="md:hidden flex items-center justify-center w-11 h-11 bg-yellow-400/10 border border-yellow-400/30 rounded-md hover:bg-yellow-400/20 hover:border-yellow-400/60 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-1 focus:ring-offset-black transition-all duration-200"
      aria-label="칀pne navigasjonsmeny"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <svg
        class="w-6 h-6 text-yellow-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
      <span class="sr-only">Meny</span>
    </button>
  </div>

  <!-- Mobilmeny - WCAG accessible -->
  <nav
    id="mobile-menu"
    class="md:hidden hidden px-6 pb-4 space-y-2 text-sm bg-black/95 border-t border-yellow-400/20"
    aria-label="Mobilnavigasjon"
    role="navigation"
  >
    {
      navLinks
        .filter(
          (link) =>
            !link.toggle ||
            (isValidToggleKey(link.toggle) && isFeatureActive(link.toggle)),
        )
        .map((link) =>
          "dropdown" in link ? (
            <details>
              <summary class="cursor-pointer hover:text-yellow-300 focus:outline-none focus:bg-yellow-400/10 py-2 px-2 rounded transition-colors">
                {t(`nav.${link.label}`)}
              </summary>
              <div class="ml-4 pl-3 border-l-2 border-yellow-700/40 space-y-1 mt-2">
                {link.dropdown.map((item) => (
                  <a
                    href={`/${currentLang}/${item.href}`}
                    target={item.external ? "_blank" : undefined}
                    rel={item.external ? "noopener noreferrer" : undefined}
                    class="block hover:text-yellow-300 focus:outline-none focus:bg-yellow-400/10 py-2 px-2 rounded transition-colors"
                  >
                    {t(`nav.${item.label}`)}
                  </a>
                ))}
              </div>
            </details>
          ) : (
            <a
              href={`/${currentLang}/${link.href}`}
              class="block hover:text-yellow-300 focus:outline-none focus:bg-yellow-400/10 py-2 px-2 rounded transition-colors"
            >
              {t(`nav.${link.label}`)}
            </a>
          ),
        )
    }

    <!-- Spr친kvalg mobil -->
    <div class="flex space-x-4 pt-4 border-t border-yellow-700/40 mt-4">
      <a
        href={switchUrl}
        class="hover:text-yellow-300 focus:outline-none focus:bg-yellow-400/10 py-2 px-2 rounded transition-colors"
        aria-label={`Bytt til ${currentLang === "no" ? "engelsk" : "norsk"}`}
      >
        {currentLang === "no" ? "游섫릖 English" : "游游 Norsk"}
      </a>
    </div>
  </nav>
</header>

<script>
  // WCAG-kompatibel mobilmeny
  document
    .getElementById("mobile-menu-toggle")
    ?.addEventListener("click", (event) => {
      const button = event.currentTarget as HTMLButtonElement;
      const menu = document.getElementById("mobile-menu");

      if (menu && button) {
        const isOpen = !menu.classList.contains("hidden");

        // Toggle synlighet
        menu.classList.toggle("hidden");

        // Oppdater ARIA-attributter
        button.setAttribute("aria-expanded", isOpen ? "false" : "true");
        button.setAttribute(
          "aria-label",
          isOpen ? "칀pne navigasjonsmeny" : "Lukk navigasjonsmeny",
        );

        // Fokus-h친ndtering
        if (!isOpen) {
          // Meny 친pnet - fokuser p친 f칮rste lenke
          const firstLink = menu.querySelector(
            "a, details summary",
          ) as HTMLElement;
          firstLink?.focus();
        }
      }
    });

  // Lukk meny ved ESC-tast (WCAG 2.1.1)
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      const menu = document.getElementById("mobile-menu");
      const button = document.getElementById(
        "mobile-menu-toggle",
      ) as HTMLButtonElement;

      if (menu && button && !menu.classList.contains("hidden")) {
        menu.classList.add("hidden");
        button.setAttribute("aria-expanded", "false");
        button.setAttribute("aria-label", "칀pne navigasjonsmeny");
        button.focus(); // Returner fokus til knappen
      }
    }
  });
</script>

<style>
  .logo-3d {
    transform: rotateX(5deg) rotateY(-5deg);
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .logo-container:hover .logo-3d {
    transform: rotateX(-2deg) rotateY(8deg) translateY(-2px) scale(1.05);
  }

  .logo-container {
    filter: drop-shadow(0 4px 12px rgba(255, 193, 7, 0.2));
    transition: filter 0.5s ease;
  }

  .logo-container:hover {
    filter: drop-shadow(0 8px 20px rgba(255, 193, 7, 0.4));
  }

  /* Subtle floating animasjon */
  @keyframes logoFloat {
    0%,
    100% {
      transform: rotateX(5deg) rotateY(-5deg) translateY(0px);
    }
    50% {
      transform: rotateX(5deg) rotateY(-5deg) translateY(-2px);
    }
  }

  .logo-3d {
    animation: logoFloat 4s ease-in-out infinite;
  }

  .logo-container:hover .logo-3d {
    animation-play-state: paused;
  }

  /* Enkel og ren glow-effekt uten synlige firkanter */
  .logo-container::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 90%;
    height: 90%;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(255, 193, 7, 0.2) 0%,
      transparent 70%
    );
    transform: translateX(-50%) translateY(-50%) scale(0.8);
    opacity: 0;
    transition:
      opacity 0.5s ease,
      transform 0.3s ease;
    pointer-events: none;
    z-index: -1;
  }

  .logo-container:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(-50%) scale(1.2);
  }
</style>
